substitutions:
  skip_updates_medium: 0 # 14 # 30sec
  skip_updates_slow: 0 # 29 # 60sec
  skip_updates_static: 60 # 120sec

esphome:
  name: growatt
  comment: "Growatt SPF 6000 ES Plus ←RS485→ Atom Lite + ATOMIC RS485 Base"
  min_version: 2025.9.1
  name_add_mac_suffix: false


esp32:
  board: m5stack-atom # Atom Lite
  framework:
    type: esp-idf

logger:
  level: INFO

api:
  encryption:
    key: !secret growatt_api_encryption_key

ota:
  - platform: esphome
    password: !secret growatt_ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

uart:
  - id: rs485_uart
    baud_rate: 9600 # Growatt 9600 8N1
    tx_pin: GPIO19 # ATOMIC RS485 Base: TX=19
    rx_pin: GPIO22 # ATOMIC RS485 Base: RX=22

modbus:
  - id: rs485
    uart_id: rs485_uart

mqtt:
  broker: !secret mqtt_host
  username: !secret mqtt_username
  password: !secret mqtt_password
  id: mqtt_client

modbus_controller:
  - id: growatt
    address: 1 # Slave 1
    modbus_id: rs485
    update_interval: 3s
    command_throttle: 100ms
    offline_skip_updates: 0

sensor:
  # ==============================================================================
  # READ REGISTERS - Sensors for reading data from the inverter (sorted by address)
  # ==============================================================================

  # Status and Control Registers (0-2)
  # System Status: Operating mode codes (0=Standby, 1=PV+Grid Discharge, 2=Discharge,
  # 3=Fault, 4=Flash, 5=PV charge, 6=AC charge, 7=Combine charge, etc.)
  # System status code: addr 0
  # Inverter operating mode: 0=Standby, 1=PV+Grid Discharge, 2=Discharge, 3=Fault,
  # 4=Flash, 5=PV charge, 6=AC charge, 7=Combine charge, 8=Combine+Bypass, etc.
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: system_status_code
    name: "System status code"
    address: 0
    register_type: read
    value_type: U_WORD
    state_class: measurement
    accuracy_decimals: 0
    skip_updates: ${skip_updates_medium}

  # PV1 voltage: addr 1
  # Solar panel 1 input voltage measurement, scale 0.1V (e.g. 330 = 33.0V)
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: pv1_voltage
    name: "PV1 voltage"
    address: 1
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # PV2 voltage: addr 2
  # Solar panel 2 input voltage measurement, scale 0.1V (returns 0 if single MPPT)
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: pv2_voltage
    name: "PV2 voltage"
    address: 2
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # PV Input Power and Current Registers (3-8)
  # PV Voltage (addr 1-2): Scale 0.1V, PV Power (addr 3-6): 32-bit values, scale 0.1W
  # Buck Current (addr 7-8): DC-DC converter current for PV1/PV2, scale 0.1A
  # PV1 power: addr 3(HI), 4(LO) (need test)
  # Solar panel 1 active power output, 32-bit value, scale 0.1W
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: pv1_power
    name: "PV1 power"
    address: 3
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # PV2 power: addr 5(HI), 6(LO) (need test)
  # Solar panel 2 active power output, 32-bit value, scale 0.1W
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: pv2_power
    name: "PV2 power"
    address: 5
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # PV1 buck current Buck1Curr: addr 7
  # DC-DC converter 1 charging current from PV1, scale 0.1A (e.g. 123 = 12.3A)
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: pv1_buck_current_a
    name: "PV1 buck current"
    address: 7
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # PV2 buck current Buck2Curr: addr 8
  # DC-DC converter 2 charging current from PV2, scale 0.1A (0 if single MPPT)
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: pv2_buck_current
    name: "PV2 buck current"
    address: 8
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # AC Output Power and Load Registers (9-16)
  # Inverter AC output active power to load, 32-bit value, scale 0.1W
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: ac_output_power
    name: "AC output power"
    address: 9
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Output Apparent Power (addr 11-12): 32-bit, scale 0.1VA
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: ac_output_apparent_power
    name: "AC output apparent power"
    address: 11
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "VA"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # AC charging power from grid to battery, 32-bit value, scale 0.1W
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: ac_charge_power
    name: "AC charge power"
    address: 13
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Undefined: addr 15(HI), 16(LO)
  # Unknown/reserved register pair, purpose unclear for SPF 6000 ES Plus
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: read_15_16
    name: "Read 15_16 U_DWORD"
    address: 15
    internal: true
    register_type: read
    value_type: U_DWORD
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Battery voltage: addr 17
  # Main battery voltage measurement, scale 0.01V for high precision (e.g. 5213 = 52.13V)
  - platform: modbus_controller
    modbus_controller_id: growatt
    name: "Battery voltage"
    id: battery_voltage
    address: 17
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.01

  # Battery SOC: addr 18
  # Battery State of Charge percentage, range 0-100%
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: battery_soc
    name: "Battery SOC"
    address: 18
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "%"
    device_class: battery
    state_class: measurement
    accuracy_decimals: 0
    skip_updates: ${skip_updates_medium}

  # DC bus voltage: addr 19
  # Internal DC bus voltage (intermediate circuit), scale 0.1V
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: dc_bus_voltage
    name: "DC bus voltage"
    address: 19
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # AC input voltage: addr 20
  # Grid/generator input voltage measurement, scale 0.1V (e.g. 2345 = 234.5V)
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: ac_input_voltage
    name: "AC input voltage"
    address: 20
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    skip_updates: ${skip_updates_medium}

  # AC input frequency: addr 21
  # Grid/generator input frequency, scale 0.01Hz (e.g. 5998 = 59.98Hz)
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: ac_input_frequency
    name: "AC input frequency"
    address: 21
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "Hz"
    device_class: frequency
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    skip_updates: ${skip_updates_medium}

  # Inverter AC output voltage, scale 0.1V
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: ac_output_voltage
    name: "AC output voltage"
    address: 22
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # AC output frequency: addr 23
  # Inverter AC output frequency, scale 0.01Hz (duplicate of addr 14)
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: ac_output_frequency
    name: "AC output frequency"
    address: 23
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "Hz"
    device_class: frequency
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.01

  # Temperature and Load Monitoring (24-35)

  # Output DC voltage: addr 24 - always 2 for spf6000ESplus?
  # DC output voltage (if available), typically unused in SPF models
  - platform: modbus_controller
    internal: true
    modbus_controller_id: growatt
    id: output_dc_voltage
    name: "Output DC voltage"
    address: 24
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 1

  # InvTemp: addr 25
  # Inverter main power module temperature, scale 0.1°C (e.g. 350 = 35.0°C)
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: inverter_temperature
    name: "Inverter Temperature"
    address: 25
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # DcDc Temp: addr 26
  # DC-DC converter (PV charging module) temperature, scale 0.1°C
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: dc_dc_temperature
    name: "DC-DC temperature"
    address: 26
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # LoadPercent: addr 27 scale 0.1%, range 0.0-100.0%
  # Current load as percentage of inverter capacity, scale 0.1% (e.g. 255 = 25.5%)
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: load_percent
    name: "Load percent"
    address: 27
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "%"
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Bat_s_Volt: addr 28 - return 0
  # Battery port voltage (DSP measurement), typically returns 0 for SPF 6000 ES Plus
  - platform: modbus_controller
    modbus_controller_id: growatt
    name: "Battery port voltage"
    id: battery_port_voltage
    internal: true
    address: 28
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    skip_updates: ${skip_updates_medium}

  # Bat_Volt_DSP: addr 29 - return 0
  # Battery voltage DSP reading, scale 0.01V, typically returns 0 for SPF 6000 ES Plus
  - platform: modbus_controller
    modbus_controller_id: growatt
    name: "Battery voltage DSP"
    id: battery_voltage_dsp
    internal: true
    address: 29
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    skip_updates: ${skip_updates_medium}

  # Time total H: addr 30 (HI), 31 (LO) - inverter total runtime
  # Total inverter operating time, 32-bit value, scale 0.5 seconds
  # Formula: ((Time_total_H << 16) | Time_total_L) * 0.5 seconds
  # Step = 0.5 seconds, converted to hours by dividing by 3600
  # NOTE: Returns 0 - possibly not supported by SPF 6000 ES Plus or resets on power cycle
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: total_running_time_hours
    internal: true
    name: "Total running time hours"
    address: 30
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "h"
    state_class: total_increasing
    accuracy_decimals: 1
    skip_updates: ${skip_updates_medium}

  # Buck1_NTC: addr 32
  # MPPT1 temperature sensor (Buck1 NTC), scale 0.1°C
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: mppt1_temperature
    name: "MPPT1 temperature"
    address: 32
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Buck2_NTC: addr 33
  # MPPT2 temperature sensor (Buck2 NTC), scale 0.1°C (0 if single MPPT)
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: mppt2_temperature
    name: "MPPT2 temperature"
    address: 33
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # OP_Curr: addr 34
  # AC output current (load current), scale 0.1A (e.g. 25 = 2.5A)
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: ac_output_current
    name: "AC output current"
    address: 34
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Inv_Curr: addr 35
  # DC current from battery to inverter, scale 0.1A (positive during discharge)
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: battery_to_inverter_current
    name: "Battery to inverter current"
    address: 35
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # AC_InWatt: addr 36(HI), 37(LO) (need test)
  # AC input power from grid (for charging or bypass), 32-bit value, scale 0.1W
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: ac_input_power
    name: "AC input power"
    address: 36
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.1

  # AC_InVA: addr 38(HI), 39(LO) (need test)
  # AC input apparent power from grid, 32-bit value, scale 0.1VA
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: ac_input_apparent_power
    name: "AC input apparent power"
    address: 38
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "VA"
    device_class: power
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.1

  # Fault Bits: addr 40
  # 16-bit fault status field: bit1=Over Temperature, bit2=Bat Voltage High,
  # bit3=Bat Voltage Low, bit4=Output short, bit5=Output voltage high, etc.
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: fault_bits
    name: "Fault bits"
    address: 40
    register_type: read
    value_type: U_WORD
    accuracy_decimals: 0
    skip_updates: ${skip_updates_medium}

  # Warn Bits: addr 41
  # 16-bit warning status field (low): bit0=Fan lock, bit1=Battery over charge,
  # bit2=Battery low, bit3=Over load, bit4=Output power derating, etc.
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: warning_bits
    name: "Warning bits"
    address: 41
    register_type: read
    value_type: U_WORD
    accuracy_decimals: 0
    skip_updates: ${skip_updates_medium}

  # Fault Code: addr 42
  # Numeric fault code for active critical errors (0 = no fault)
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: fault_code
    name: "Fault code"
    address: 42
    register_type: read
    value_type: U_WORD
    accuracy_decimals: 0
    skip_updates: ${skip_updates_medium}

  # Warning Code: addr 43
  # Numeric warning code for active warnings (0 = no warning)
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: warning_code
    name: "Warning code"
    address: 43
    register_type: read
    value_type: U_WORD
    accuracy_decimals: 0
    skip_updates: ${skip_updates_medium}

  # DSP firmware: addr 44
  # Device Type Code (DTC) for model identification (034xx for SPF 3-5K series)
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: dsp_firmware
    name: "DSP firmware"
    address: 44
    register_type: read
    value_type: U_WORD
    accuracy_decimals: 0
    skip_updates: ${skip_updates_slow}

  # Energy counters and system currents (registers 45–89)
  # Reserved Registers (45-47)

  # Check Step: addr 45
  # - platform: modbus_controller
  #   modbus_controller_id: growatt
  #   id: check_step
  #   internal: true
  #   name: "Check step"
  #   address: 45
  #   register_type: read
  #   value_type: U_WORD
  #   accuracy_decimals: 0
  #   skip_updates: ${skip_updates_medium}

  # Production Line Mode: addr 46
  # - platform: modbus_controller
  #   modbus_controller_id: growatt
  #   id: production_line_mode
  #   internal: true
  #   name: "Production line mode"
  #   address: 46
  #   register_type: read
  #   value_type: U_WORD
  #   accuracy_decimals: 0
  #   skip_updates: ${skip_updates_medium}

  # ConstantPowerOKFlag: addr 47
  # - platform: modbus_controller
  #   modbus_controller_id: growatt
  #   id: constant_power_ok_flag
  #   internal: true
  #   name: "Constant power OK flag"
  #   address: 47
  #   register_type: read
  #   value_type: U_WORD
  #   accuracy_decimals: 0
  #   skip_updates: ${skip_updates_medium}

  # Epv1_today: addr 48(HI), 49(LO) - today energy from pv1+pv2 (not pv1 only)
  # Total PV energy generated today (PV1+PV2 combined), 32-bit value, scale 0.1kWh
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: pv_energy_today
    name: "PV energy today"
    address: 48
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.1
    skip_updates: ${skip_updates_medium}

  # Epv1_total: addr 50(HI), 51(LO) - total energy from pv1+pv2 (not pv1 only)
  # Total PV energy generated lifetime (PV1+PV2 combined), 32-bit value, scale 0.1kWh
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: pv_energy_total
    name: "PV energy total"
    address: 50
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    filters:
      - multiply: 0.1
    skip_updates: ${skip_updates_medium}

  # Epv2_today: addr 52(HI), 53(LO) - (not works for spf6000ESplus)
  # PV2 energy generated today, 32-bit value, scale 0.01kWh (unused in SPF 6000 ES Plus)
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: pv2_energy_today_kwh
    internal: true
    name: "PV2 energy today"
    address: 52
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    skip_updates: ${skip_updates_medium}

  # Epv2_total: addr 54(HI), 55(LO) - (not works for spf6000ESplus)
  # PV2 energy generated lifetime, 32-bit value, scale 0.01kWh (unused in SPF 6000 ES Plus)
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: pv2_energy_total_kwh
    internal: true
    name: "PV2 energy total"
    address: 54
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    skip_updates: ${skip_updates_medium}

  # Eac_charge_today: addr 56(HI), 57(LO)
  # Energy charged from grid to battery today, 32-bit value, scale 0.1kWh
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: ac_charge_energy_today
    name: "AC charge energy today"
    address: 56
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.1
    skip_updates: ${skip_updates_medium}

  # Eac_charge_total: addr 58(HI), 59(LO)
  # Energy charged from grid to battery lifetime, 32-bit value, scale 0.1kWh
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: ac_charge_energy_total
    name: "AC charge energy total"
    address: 58
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    filters:
      - multiply: 0.1
    skip_updates: ${skip_updates_medium}

  # Ebat_discharge_today: addr 60(HI), 61(LO)
  # Energy discharged from battery today, 32-bit value, scale 0.1kWh
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: battery_discharge_energy_today
    name: "Battery discharge energy today"
    address: 60
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.1
    skip_updates: ${skip_updates_medium}

  # Ebat_discharge_total: addr 62(HI), 63(LO)
  # Energy discharged from battery lifetime, 32-bit value, scale 0.1kWh
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: battery_discharge_energy_total
    name: "Battery discharge energy total"
    address: 62
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    filters:
      - multiply: 0.1
    skip_updates: ${skip_updates_medium}

  # Eac_discharge_today: addr 64(HI), 65(LO)
  # Energy delivered to AC load today (inverter output), 32-bit value, scale 0.1kWh
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: ac_discharge_energy_today
    name: "AC discharge energy today"
    address: 64
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.1
    skip_updates: ${skip_updates_medium}

  # Eac_discharge_total: addr 66(HI), 67(LO)
  # Energy delivered to AC load lifetime (inverter output), 32-bit value, scale 0.1kWh
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: ac_discharge_energy_total
    name: "AC discharge energy total"
    address: 66
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    filters:
      - multiply: 0.1
    skip_updates: ${skip_updates_medium}


  # ACChrCurr: AC Charging Current (addr 68): Current flow from grid to battery, scale 0.1A
  # Current flowing from grid to battery during AC charging, scale 0.1A
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: ac_charging_battery_current
    name: "AC Charging Battery Current"
    address: 68
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # AC_DischrWatt: Power discharged to grid (reverse power flow), 32-bit signed, scale 0.1W (typically 0 for off-grid)
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: ac_discharging_power
    internal: true
    name: "AC discharging power"
    address: 69
    register_type: read
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # AC_DischrVA: Apparent power discharged to grid, 32-bit signed, scale 0.1VA (typically 0 for off-grid)
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: ac_discharging_apparent_power
    internal: true
    name: "AC discharging apparent power"
    address: 71
    register_type: read
    value_type: S_DWORD
    unit_of_measurement: "VA"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Bat_DischrWatt: Battery discharge power (power flowing from battery), 32-bit signed, scale 0.1W
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: battery_discharging_power
    name: "Battery discharging power"
    address: 73
    register_type: read
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Bat_DischrVA: Battery discharge apparent power, 32-bit signed, scale 0.1VA
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: battery_discharging_apparent_power
    name: "Battery discharging apparent power"
    address: 75
    register_type: read
    value_type: S_DWORD
    unit_of_measurement: "VA"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Net battery power: positive=discharge, negative=charge, 32-bit signed, scale 0.1W
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: battery_power
    name: "Battery power"
    address: 77
    register_type: read
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # uwSlaveExistCnt: addr 79 - number of parallel units (1-4)
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: parallel_units
    internal: true
    name: "Parallel units"
    address: 79
    register_type: read
    value_type: U_WORD
    accuracy_decimals: 0

  # BatOverCharge: addr 80 - always 0?
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: battery_overcharge
    internal: true
    name: "Battery overcharge"
    address: 80
    register_type: read
    value_type: U_WORD
    accuracy_decimals: 0

  # MpptFanSpeed: MPPT cooling fan speed percentage, range 0-100%
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: mppt_fan_speed
    name: "MPPT fan speed"
    address: 81
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "%"
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 1

  # InvFanSpeed: Inverter cooling fan speed percentage, range 0-100%
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: inv_fan_speed
    name: "Fan speed"
    address: 82
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "%"
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 1

  # TotalChgCurr: Total charging current to battery from all sources (PV+AC), scale 0.1A
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: total_charge_current
    name: "Total charge current"
    address: 83
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # TotalDisChgCurr: Total discharge current from battery, scale 0.1A
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: total_discharge_current
    name: "Total discharge current"
    address: 84
    register_type: read
    value_type: U_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # These registers may duplicate earlier energy counters or provide parallel system data
  # Eop_dischrToday: Output discharge energy today (alternative to AC discharge), 32-bit value, scale 0.1kWh
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: discharge_energy_today
    name: "Discharge energy today"
    address: 85
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.1
    skip_updates: ${skip_updates_medium}

  # Discharge energy total (alternative to AC discharge), 32‑bit (87–88), ×0.1 kWh.
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: discharge_energy_total
    name: "Discharge energy total"
    address: 87
    register_type: read
    value_type: U_DWORD
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.1
    skip_updates: ${skip_updates_medium}

  # ParaChgCurr: Parallel Charge Current (addr 89): Total charging current in parallel systems
  # ParaChgCurr: addr 90 (duplicate?)

  # ParaDischgCurr: addr 91 - Total paralleling discharge current

  # Battery Current: addr 92 - BMS reading battery current (always 429.4 - what is it?)
  # - platform: modbus_controller
  #   modbus_controller_id: growatt
  #   name: "Battery current"
  #   address: 92
  #   register_type: read
  #   value_type: S_WORD
  #   unit_of_measurement: "A"
  #   device_class: current
  #   state_class: measurement
  #   accuracy_decimals: 1
  #   filters:
  #     - multiply: 0.1

  # Battery State of Charge, %: addr 93 (always 0 - what is it? duplicate addr 18?)
  # - platform: modbus_controller
  #   modbus_controller_id: growatt
  #   name: "Battery SOC (BMS)"
  #   address: 93
  #   register_type: read
  #   value_type: U_WORD
  #   unit_of_measurement: "%"
  #   device_class: battery
  #   state_class: measurement
  #   accuracy_decimals: 0

  # Battery Remaining Capacity, Ah: addr 94 (always 0 - what is it?)
  # - platform: modbus_controller
  #   modbus_controller_id: growatt
  #   name: "Battery remaining capacity"
  #   address: 94
  #   register_type: read
  #   value_type: U_WORD
  #   unit_of_measurement: "Ah"
  #   device_class: battery
  #   state_class: measurement
  #   accuracy_decimals: 2

  # +Nominal/Full Charge Capacity: addr 95 (batt 1 only)
  # - platform: modbus_controller
  #   modbus_controller_id: growatt
  #   name: "Battery nominal capacity"
  #   address: 95
  #   register_type: read
  #   value_type: U_WORD
  #   unit_of_measurement: "Ah"
  #   device_class: battery
  #   state_class: measurement
  #   accuracy_decimals: 2

  # +Battery Cycle Count: addr 96 (batt 1 only)
  # - platform: modbus_controller
  #   modbus_controller_id: growatt
  #   name: "Battery cycle count"
  #   address: 96
  #   register_type: read
  #   value_type: U_WORD
  #   state_class: measurement
  #   accuracy_decimals: 2
  #   filters:
  #     - multiply: 1
  #     - lambda: return x * 0.01;   # 1921 * 0.01 = 19.21

  # ==============================================================================
  # HOLDING REGISTERS - Sensors for configuration and control (sorted by address)
  # ==============================================================================

  # Battery type code (or FW/COM build code depending on firmware)
  # Battery type configuration: 0=AGM, 1=Flooded, 2=User, 3=Lithium, 4=User2
  - platform: modbus_controller
    modbus_controller_id: growatt
    id: battery_type_code
    name: "Battery type code"
    address: 39
    register_type: holding
    value_type: U_WORD
    accuracy_decimals: 0
    skip_updates: ${skip_updates_static}